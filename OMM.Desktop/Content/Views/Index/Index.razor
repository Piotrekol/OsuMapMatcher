@page "/"
@using OMM.Desktop.Data.OsuDataProvider
@using OMM.Desktop.Data.OmmApi
@inject OsuDataProvider OsuDataProvider
@inject OmmApiService OmmApi
@implements IDisposable

<div class="@Bem.Base()">
    <MapImage SongSelection="@songSelection" />
    <div class="@Bem.Element("search-container")">
        <span class="@Bem.Element("search-container-label")">
            Custom Search
        </span>
        <IconButton Text="Find matching maps"
                    IconName="fa-search"
                    Style="fas"
                    RootClass="@Bem.Element("search-button")"
                    OnClick="HandleSearchClick" />
        <FilterChips FilterClass="@Filter" OnChange="HandleChipChange"/>
    </div>
    @foreach (var map in this.MapMatches)
    {
        <MapMatchTile MapMatch="map" />
    }
    <ErrorMessage ErrorMessages="errorMessages"/>
</div>

@code{
    private Bem Bem = new Bem("view-index");

    private SongSelectionChangedEventArgs songSelection = null;

    private List<MapMatch> MapMatches = new List<MapMatch>();

    private List<string> errorMessages = new List<string>();

    private OmmApiFilterDto Filter = new OmmApiFilterDto
    {
        Count = 10,
    };

    protected override void OnInitialized()
    {
        OsuDataProvider.SongChanged += this.SongChanged;
    }

    public void Dispose()
    {
        OsuDataProvider.SongChanged -= this.SongChanged;
    }

    private async void HandleSearchClick()
    {
        var mapsOrErrors = await OmmApi.GetMapMatches(songSelection?.BeatmapId, Filter.Count);
        if (mapsOrErrors.TryGetLeftValue(out var maps))
        {
            this.MapMatches = maps;
            await InvokeAsync(() => base.StateHasChanged());
            return;
        }

        this.errorMessages = mapsOrErrors.Right;
    }

    private async void SongChanged(object sender, SongSelectionChangedEventArgs e)
    {
        this.songSelection = e;

        await InvokeAsync(() => base.StateHasChanged());
    }

    private void HandleChipChange(object o)
    {
        this.Filter = o as OmmApiFilterDto;
    }
}